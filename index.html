<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美股進階分析工具 - 波動度/費波那契/量價</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 10px; margin-bottom: 30px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid #007bff; }
        .stat-card h4 { margin: 0 0 10px 0; color: #666; font-size: 14px; }
        .stat-card p { margin: 0; font-size: 20px; font-weight: bold; color: #222; }
        #chart { width: 100%; height: 500px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>美股進階申購判斷工具</h2>
        <div class="input-group">
            <input type="text" id="tickerInput" placeholder="輸入美股代碼 (如: NVDA, TSLA, AAPL)">
            <button onclick="fetchStockData()">開始即時分析</button>
        </div>

        <div class="dashboard">
            <div class="stat-card">
                <h4>年化波動度</h4>
                <p id="volValue">-- %</p>
            </div>
            <div class="stat-card">
                <h4>費波那契 0.618 支撐</h4>
                <p id="fibValue">--</p>
            </div>
            <div class="stat-card">
                <h4>量價狀態</h4>
                <p id="volStatus">--</p>
            </div>
        </div>

        <div id="chart"></div>
    </div>

    <script>
        async function fetchStockData() {
            const ticker = document.getElementById('tickerInput').value.toUpperCase();
            if(!ticker) return alert("請輸入標的代碼");

            // 使用 Finnhub 或 Alpha Vantage 的免費 API (此處為示意，建議申請 API Key 替換)
            const proxy = "https://query1.finance.yahoo.com/v8/finance/chart/" + ticker + "?range=6mo&interval=1d";
            
            try {
                // 注意：跨域問題通常需透過後端或特定的 API 服務處理
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(proxy)}`);
                const data = JSON.parse((await response.json()).contents);
                const result = data.chart.result[0];
                const timestamps = result.timestamp.map(t => new Date(t * 1000).toLocaleDateString());
                const closePrices = result.indicators.quote[0].close;
                const highPrices = result.indicators.quote[0].high;
                const lowPrices = result.indicators.quote[0].low;
                const volumes = result.indicators.quote[0].volume;

                // 1. 計算波動度 (最近20日)
                let returns = [];
                for(let i=1; i<20; i++) returns.push((closePrices[closePrices.length-i] - closePrices[closePrices.length-i-1]) / closePrices[closePrices.length-i-1]);
                const std = Math.sqrt(returns.map(x => Math.pow(x - (returns.reduce((a,b)=>a+b)/20), 2)).reduce((a,b)=>a+b)/20);
                const annualizedVol = (std * Math.sqrt(252) * 100).toFixed(2);
                document.getElementById('volValue').innerText = annualizedVol + " %";

                // 2. 費波那契計算
                const maxH = Math.max(...highPrices);
                const minL = Math.min(...lowPrices);
                const fib618 = (maxH - 0.618 * (maxH - minL)).toFixed(2);
                document.getElementById('fibValue').innerText = fib618;

                // 3. 量價判斷
                const lastVol = volumes[volumes.length - 1];
                const avgVol = volumes.slice(-20).reduce((a,b)=>a+b) / 20;
                document.getElementById('volStatus').innerText = lastVol > avgVol ? "量增" : "量縮";

                // 4. 繪圖
                const trace = {
                    x: timestamps,
                    close: closePrices,
                    high: highPrices,
                    low: lowPrices,
                    open: result.indicators.quote[0].open,
                    type: 'candlestick',
                    name: ticker
                };
                const fibLine = {
                    type: 'line', x0: timestamps[0], x1: timestamps[timestamps.length-1],
                    y0: fib618, y1: fib618, line: { color: 'red', width: 2, dash: 'dash' }, name: '0.618 Support'
                };
                
                Plotly.newPlot('chart', [trace], {
                    title: ticker + ' 走勢與費波那契支撐線',
                    shapes: [fibLine]
                });

            } catch (e) {
                alert("抓取失敗，請確認代碼是否正確或 API 限制");
                console.error(e);
            }
        }
    </script>
</body>
</html>
