<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡å‹ç‡è¨ºæ–·å„€ - å®Œå…¨é«”</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; }
        .input-group { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; min-width: 120px; padding: 14px; border: 2px solid #e4e6eb; border-radius: 12px; font-size: 16px; outline: none; }
        button { padding: 14px; background: #0062ff; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; }
        button:disabled { background: #ccc; }
        .score-box { background: linear-gradient(135deg, #0062ff, #00c6ff); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; display: none; }
        .score-val { font-size: 40px; font-weight: 900; display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .box { background: #f8f9fa; border: 1px solid #eee; padding: 12px; border-radius: 12px; text-align: center; }
        .box span { font-size: 11px; color: #65676b; display: block; }
        .box b { font-size: 16px; color: #1c1e21; }
        .report-card { background: #fff; border-left: 6px solid #0062ff; padding: 18px; border-radius: 10px; border: 1px solid #eee; border-left-width: 6px; line-height: 1.8; font-size: 14px; display: none; margin-bottom: 20px; }
        #chart { width: 100%; height: 450px; border-radius: 15px; }
        .loading { display: none; text-align: center; color: #0062ff; font-weight: bold; padding: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>âš–ï¸ ç¾è‚¡å‹ç‡è¨ºæ–·å„€ (å®Œå…¨é«”)</h2>
        <p style="color:#666; font-size:13px;">æŠ€è¡“æŒ‡æ¨™ Ã— è²¡å‹™é«”è³ª Ã— é æœŸæ¸¬è©¦</p>
    </div>

    <div class="input-group">
        <input type="text" id="sym" placeholder="ä»£ç¢¼ (å¦‚: PLTR)">
        <input type="number" id="kP" placeholder="K ç·šé è¨ˆç”³è³¼åƒ¹">
        <button id="btn" onclick="runCompleteAnalysis()">åŸ·è¡Œæ·±åº¦è¨ºæ–·</button>
    </div>

    <div id="loader" class="loading">âš™ï¸ æ­£åœ¨å®‰å…¨ç©¿é€æ•¸æ“šé€šé“ (è«‹ç¨å€™)...</div>

    <div id="scoreBox" class="score-box">
        <span>å‹ç‡å®‰å…¨è©•åˆ†</span>
        <b id="scoreVal" class="score-val">--</b>
    </div>

    <div id="statGrid" class="grid" style="display:none;">
        <div class="box"><span>ç¾åƒ¹</span><b id="curP">--</b></div>
        <div class="box"><span>å¹´ç·šä¹–é›¢</span><b id="bias">--%</b></div>
        <div class="box"><span>å‰ç» P/E</span><b id="pe">--</b></div>
        <div class="box"><span>å‹•æ…‹åœåˆ©ç·š</span><b id="stop">--</b></div>
    </div>

    <div id="report" class="report-card"></div>
    <div id="chart"></div>
</div>

<script>
async function runCompleteAnalysis() {
    const symbol = document.getElementById('sym').value.toUpperCase().trim();
    const kP = parseFloat(document.getElementById('kP').value);
    if(!symbol) return;

    const btn = document.getElementById('btn');
    const loader = document.getElementById('loader');
    const scoreBox = document.getElementById('scoreBox');
    const statGrid = document.getElementById('statGrid');
    const reportBox = document.getElementById('report');
    
    btn.disabled = true;
    loader.style.display = 'block';
    scoreBox.style.display = 'none';
    statGrid.style.display = 'none';
    reportBox.style.display = 'none';

    const proxy = u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&_t=${Date.now()}`;

    try {
        const cRes = await fetch(proxy(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=2y&interval=1d`));
        const cData = JSON.parse((await cRes.json()).contents).chart.result[0];
        
        await new Promise(r => setTimeout(r, 1200));

        const fRes = await fetch(proxy(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData`));
        const fData = JSON.parse((await fRes.json()).contents).quoteSummary.result[0];

        const close = cData.indicators.quote[0].close.filter(p => p != null);
        const curPrice = close[close.length - 1];
        const ma200 = close.slice(-200).reduce((a, b) => a + b) / 200;
        const bias = ((curPrice - ma200) / ma200 * 100).toFixed(2);
        const hi = Math.max(...cData.indicators.quote[0].high.filter(p => p != null));
        const lo = Math.min(...cData.indicators.quote[0].low.filter(p => p != null));
        const stopL = (Math.max(...close.slice(-20)) * 0.85).toFixed(2);

        // åŸºæœ¬é¢
        const pe = fData.summaryDetail?.forwardPE?.fmt || "N/A";
        const fcf = fData.financialData?.freeCashflow?.raw || 0;
        const debt = fData.financialData?.debtToEquity?.raw || 0;

        // è©•åˆ†é‚è¼¯
        let s = 85;
        if(parseFloat(bias) > 35) s -= 30;
        if(parseFloat(bias) < -15) s -= 10;
        if(fcf < 0) s -= 15;
        if(debt > 150) s -= 10;

        // UI æ›´æ–°
        document.getElementById('scoreVal').innerText = s + " / 100";
        document.getElementById('curP').innerText = "$" + curPrice.toFixed(2);
        document.getElementById('bias').innerText = bias + "%";
        document.getElementById('pe').innerText = pe;
        document.getElementById('stop').innerText = "$" + stopL;

        let rText = `<b>ğŸ¯ æ·±åº¦è¨ºæ–·å ±å‘Šï¼š</b><br>`;
        rText += `â€¢ <b>è²¡å‹™é«”è³ªï¼š</b>ç¾é‡‘æµ ${fcf < 0 ? 'âš  è² å‘ç‡’éŒ¢' : 'âœ… å¥å…¨'}ï¼Œå‚µå‹™æ¯” ${debt.toFixed(0)}%ã€‚<br>`;
        rText += `â€¢ <b>æ”¯æ’åƒè€ƒï¼š</b> è²»æ³¢é‚£å¥‘ 0.618 ä½éšåœ¨ <b>$${(hi - 0.618 * (hi - lo)).toFixed(2)}</b>ã€‚<br>`;
        if(kP) {
            const fib618 = hi - 0.618 * (hi - lo);
            rText += `â€¢ <b>é æœŸæ¸¬è©¦ï¼š</b> $${kP} ${kP <= fib618 ? 'ğŸ”¥ è™•æ–¼å„ªè³ªæ”¯æ’' : 'â³ ç•¥é¡¯è¿½é«˜'}ï¼Œèˆ‡æ”¯æ’åé›¢ ${((kP-fib618)/fib618*100).toFixed(1)}%ã€‚<br>`;
        }
        rText += `<hr><b>ğŸ“œ ç´€å¾‹ï¼š</b> ç•¶å‰åƒ¹ä½${curPrice < parseFloat(stopL) ? ' âš  å·²è·Œç ´åœåˆ©ç·š' : ' å®ˆåœ¨åœåˆ©ç·šä¸Š'}ã€‚è·Œç ´ $${stopL} è«‹å‹™å¿…åŸ·è¡Œæ¸›ç¢¼ã€‚`;
        
        scoreBox.style.display = 'block';
        statGrid.style.display = 'grid';
        reportBox.innerHTML = rText;
        reportBox.style.display = 'block';

        // æ¨¡æ“¬è·¯å¾‘
        let paths = [];
        for(let i=0; i<40; i++){
            let p = [curPrice];
            for(let d=0; d<180; d++){ p.push(p[p.length-1] * (1 + (Math.random()-0.49)*0.038)); }
            paths.push(p);
        }
        Plotly.newPlot('chart', paths.map(p=>({y:p, line:{width:0.5, color:'rgba(0,98,255,0.1)'}, showlegend:false})), {title: `${symbol} 180å¤©æ©Ÿç‡è·¯å¾‘`});

    } catch (e) {
        alert("API é€£ç·šè¶…æ™‚ã€‚è«‹é–‹å•Ÿé£›èˆªæ¨¡å¼æ›´æ› IP ä¸¦ç­‰å¾… 30 ç§’ã€‚");
    } finally {
        loader.style.display = 'none';
        setTimeout(() => { btn.disabled = false; }, 3000);
    }
}
</script>
</body>
</html>
