<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡çµ‚æ¥µå‹ç‡è¨ºæ–·ç³»çµ± - Kç·šèˆ‡é‡åŒ–æ•´åˆç‰ˆ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #1c1e21; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #f0f2f5; padding-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        input { flex: 1; min-width: 200px; padding: 15px; border: 2px solid #e4e6eb; border-radius: 12px; font-size: 16px; outline: none; }
        input:focus { border-color: #0062ff; }
        button { padding: 15px 30px; background: #0062ff; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        button:hover { background: #0052d6; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .stat-card span { font-size: 12px; color: #65676b; display: block; margin-bottom: 8px; }
        .stat-card b { font-size: 20px; color: #050505; }

        .analysis-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        @media (max-width: 768px) { .analysis-container { grid-template-columns: 1fr; } }
        
        .report-box { background: #f8f9fa; border-left: 8px solid #0062ff; padding: 20px; border-radius: 12px; line-height: 1.8; font-size: 14px; }
        .k-box { background: #fff; border: 2px solid #e7f3ff; border-left: 8px solid #28a745; padding: 20px; border-radius: 12px; line-height: 1.8; font-size: 14px; }

        .fib-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        .fib-table th, .fib-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f2f5; }
        .fib-table th { color: #888; background: #fafafa; }

        #chart { width: 100%; height: 500px; border-radius: 15px; margin-top: 20px; }
        .loading { display: none; text-align: center; color: #0062ff; font-weight: bold; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ’ ç¾è‚¡çµ‚æ¥µå‹ç‡è¨ºæ–·å„€</h2>
        <p>é‡åŒ–æ•¸æ“š Ã— Kç·šæ”¯æ’ Ã— ç´€å¾‹ç®¡ç†</p>
    </div>

    <div class="input-group">
        <input type="text" id="sym" placeholder="ä»£ç¢¼ (å¦‚: LEU, MU)">
        <input type="number" id="kPrice" placeholder="ä½ çš„ Kç·šé æœŸç”³è³¼åƒ¹">
        <button onclick="executeAnalysis()">åŸ·è¡Œå…¨è¦ç´ è¨ºæ–·</button>
    </div>

    <div id="loader" class="loading">âš™ï¸ æ­£åœ¨å‘å¤§æ•¸æ“šæ¥å£è«‹æ±‚ä¸¦è¨ˆç®—å‹ç‡æ©Ÿç‡...</div>

    <div id="mainUI" style="display:none;">
        <div class="dashboard-grid">
            <div class="stat-card"><span>å®‰å…¨è©•åˆ†</span><b id="v_score">--</b></div>
            <div class="stat-card"><span>å¹´ç·šä¹–é›¢ (Bias)</span><b id="v_bias">--%</b></div>
            <div class="stat-card"><span>å‹•æ…‹åœåˆ©ç·š</span><b id="v_stop">--</b></div>
            <div class="stat-card"><span>180å¤©é ä¼°ä¸­ä½</span><b id="v_target">--</b></div>
        </div>

        <div class="analysis-container">
            <div id="dataReport" class="report-box"></div>
            <div id="kReport" class="k-box"></div>
        </div>

        <table class="fib-table">
            <thead>
                <tr><th>è²»æ³¢é‚£å¥‘ä½éš</th><th>åƒè€ƒåƒ¹æ ¼</th><th>é‡åŒ–æ“ä½œå»ºè­°</th></tr>
            </thead>
            <tbody id="fibBody"></tbody>
        </table>

        <div id="chart"></div>
    </div>
</div>

<script>
async function executeAnalysis() {
    const symbol = document.getElementById('sym').value.toUpperCase().trim();
    const kPrice = parseFloat(document.getElementById('kPrice').value);
    if(!symbol) return;

    document.getElementById('loader').style.display = 'block';
    document.getElementById('mainUI').style.display = 'none';

    try {
        const proxy = url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        const [cRes, fRes] = await Promise.all([
            fetch(proxy(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=2y&interval=1d`)).then(r=>r.json()),
            fetch(proxy(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData`)).then(r=>r.json())
        ]);

        const cData = JSON.parse(cRes.contents).chart.result[0];
        const fData = JSON.parse(fRes.contents).quoteSummary.result[0];
        const close = cData.indicators.quote[0].close.filter(p=>p!=null);
        const curP = close[close.length-1];

        // 1. æŠ€è¡“æŒ‡æ¨™
        const ma200 = close.slice(-200).reduce((a,b)=>a+b)/200;
        const bias = ((curP - ma200)/ma200*100).toFixed(2);
        const hi = Math.max(...cData.indicators.quote[0].high.filter(p=>p!=null));
        const lo = Math.min(...cData.indicators.quote[0].low.filter(p=>p!=null));
        const diff = hi - lo;
        const stopLine = (Math.max(...close.slice(-20)) * 0.85).toFixed(2);

        // 2. è²»æ³¢é‚£å¥‘
        const fibs = [
            {lv:"0.382", p:(hi-0.382*diff).toFixed(2), n:"å¼·å‹¢è‚¡å›æª”æ”¯æ’"},
            {lv:"0.618", p:(hi-0.618*diff).toFixed(2), n:"é»ƒé‡‘ç”³è³¼ä½"},
            {lv:"0.786", p:(hi-0.786*diff).toFixed(2), n:"æ·±å±¤ä¿®æ­£åº•ç·š"}
        ];

        // 3. åŸºæœ¬é¢èˆ‡è©•åˆ†
        const fPE = fData.summaryDetail.forwardPE?.fmt || "N/A";
        const fcf = fData.financialData.freeCashflow?.raw || 0;
        const debt = fData.financialData.debtToEquity?.raw || 0;
        const short = fData.defaultKeyStatistics.shortPercentOfFloat?.raw || 0;
        
        let winScore = 85;
        if(parseFloat(bias) > 40) winScore -= 30;
        if(fcf < 0) winScore -= 15;
        if(debt > 120) winScore -= 10;
        if(short > 10) winScore -= 10;

        // UI æ›´æ–°
        document.getElementById('v_score').innerText = winScore + " / 100";
        document.getElementById('v_bias').innerText = bias + "%";
        document.getElementById('v_stop').innerText = stopLine;
        document.getElementById('fibBody').innerHTML = fibs.map(f=>`<tr><td>${f.lv}</td><td><b>${f.p}</b></td><td>${f.n}</td></tr>`).join('');

        // å ±å‘Šè¼¸å‡º
        document.getElementById('dataReport').innerHTML = `
            <b>ğŸ“Š æ•¸æ“šè¨ºæ–·çµè«–ï¼š</b><br>
            â€¢ <b>ä¼°å€¼ï¼š</b> ${fPE==='N/A'?'è™§æä¸­':'å‰ç» P/E '+fPE}ï¼Œç¾é‡‘æµï¼š${fcf<0?'âš  è² å‘':'âœ… æ­£å‘'}<br>
            â€¢ <b>ç±Œç¢¼ï¼š</b> ç©ºå–®æ¯”ä¾‹ ${short.toFixed(2)}%ã€‚${short>10?'âš  é­æ”¾ç©ºå£“åŠ›':'âœ… ç±Œç¢¼ç©©å®š'}<br>
            â€¢ <b>ä¿è­·ï¼š</b> ç²åˆ©ä¸­è«‹å®ˆä½ <b>${stopLine}</b> ä¿è­·ç·šã€‚<br>
            â€¢ <b>å»ºè­°ï¼š</b> ${winScore > 70 ? 'ğŸŸ¢ é©åˆç”³è³¼' : 'ğŸ”´ å»ºè­°æ¸›é‡æˆ–è§€æœ›'}
        `;

        // Kç·šå£“åŠ›æ¸¬è©¦
        if(kPrice) {
            const gap = ((kPrice - fibs[1].p)/fibs[1].p*100).toFixed(1);
            document.getElementById('kReport').innerHTML = `
                <b>ğŸ¯ Kç·šç”³è³¼åƒ¹è©•ä¼° (${kPrice})ï¼š</b><br>
                â€¢ <b>ä½éšåˆ¤æ–·ï¼š</b> ${kPrice <= fibs[1].p ? 'ğŸ”¥ å„ªè³ªä½ä½' : 'â³ ç¨å«Œè¿½é«˜'}<br>
                â€¢ <b>åé›¢åº¦ï¼š</b> è· 0.618 æ”¯æ’ç´„ ${gap}%<br>
                â€¢ <b>ç´€å¾‹å»ºè­°ï¼š</b> ${kPrice < ma200 ? 'âœ… åº•éƒ¨å»ºå€‰ï¼Œå®‰å…¨é‚Šéš›å¤§ã€‚' : 'âš  ä»é«˜æ–¼å¹´ç·šï¼Œé ˆé˜²å‡çªç ´ã€‚'}<br>
                â€¢ <b>æé†’ï¼š</b> ç”³è³¼é‡‘é¡å‹¿è¶…éç¸½è³‡ç”¢ 15%ã€‚
            `;
        } else {
            document.getElementById('kReport').innerHTML = "ğŸ’¡ <b>Kç·šæé†’ï¼š</b><br>åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥ä½ çš„é æœŸè²·é»ï¼Œå³å¯é€²è¡Œå£“åŠ›æ¸¬è©¦ã€‚";
        }

        // 180å¤©ç†æ€§æ¨¡æ“¬
        let rets = []; for(let i=1; i<45; i++) rets.push(Math.log(close[close.length-i]/close[close.length-i-1]));
        const mu = (rets.reduce((a,b)=>a+b)/45) * 0.35;
        const sigma = Math.sqrt(rets.map(x=>Math.pow(x-(mu/0.35),2)).reduce((a,b)=>a+b)/45);
        let paths = [];
        for(let i=0; i<60; i++){
            let p = [curP];
            for(let d=0; d<180; d++){ p.push(p[p.length-1] * Math.exp((mu - 0.5 * sigma**2) + sigma * (Math.random()*2-1)*1.15)); }
            paths.push(p);
        }
        document.getElementById('v_target').innerText = paths[0][180].toFixed(2);
        
        Plotly.newPlot('chart', paths.map(p=>({y:p, type:'scatter', mode:'lines', line:{width:0.6, color:'rgba(0,98,255,0.1)'}, showlegend:false})), {
            title: `${symbol} 180å¤©ç†æ€§æœŸæœ›è·¯å¾‘ (å¯†é›†å€ç‚ºé«˜æ©Ÿç‡å€)`,
            xaxis: {title: 'æœªä¾†å¤©æ•¸'}, yaxis: {title: 'é ä¼°åƒ¹æ ¼'}
        });

        document.getElementById('mainUI').style.display = 'block';

    } catch (e) { alert("æ•¸æ“šè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªä»£ç¢¼æˆ–ç¨å¾Œå†è©¦ã€‚"); }
    finally { document.getElementById('loader').style.display = 'none'; }
}
</script>
</body>
</html>
