<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¾è‚¡ 180 å¤©èµ°å‹¢æ¨¡æ“¬èˆ‡è²»æ³¢é‚£å¥‘å·¥å…·</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; max-width: 1000px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .stat-box h5 { margin: 0 0 8px 0; color: #666; font-size: 14px; }
        .stat-box p { margin: 0; font-size: 18px; font-weight: bold; }
        #chart { width: 100%; height: 600px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ç¾è‚¡ 180 å¤©èµ°å‹¢é æ¸¬å„€è¡¨æ¿</h2>
        <div class="input-group">
            <input type="text" id="tickerInput" placeholder="è¼¸å…¥ç¾è‚¡ä»£ç¢¼ (å¦‚: NVDA)">
            <button onclick="analyzeStock()">é–‹å§‹ 180 å¤©æ¨¡æ“¬åˆ†æ</button>
        </div>

        <div id="aiAnalysis" style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display:none;">
            <p id="conclusionText">æ­£åœ¨é€²è¡Œ 1,000 æ¬¡æ¨¡æ“¬é‹ç®—...</p>
        </div>

        <div class="summary-grid">
            <div class="stat-box"><h5>20æ—¥å¹´åŒ–æ³¢å‹•åº¦</h5><p id="volValue">-- %</p></div>
            <div class="stat-box"><h5>0.618 é»ƒé‡‘æ”¯æ’</h5><p id="fib618">--</p></div>
            <div class="stat-box"><h5>æœªä¾† 180 å¤©é›†ä¸­å€</h5><p id="targetRange">--</p></div>
        </div>

        <div id="chart"></div>
        
        <div style="margin-top: 20px; font-size: 13px; color: #888;">
            * è²»æ³¢é‚£å¥‘åƒè€ƒä½ï¼š<span id="allFibs">ç­‰å¾…æ•¸æ“š...</span>
        </div>
    </div>

    <script>
        async function analyzeStock() {
            const ticker = document.getElementById('tickerInput').value.toUpperCase();
            if(!ticker) return;
            document.getElementById('aiAnalysis').style.display = 'block';

            try {
                const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent("https://query1.finance.yahoo.com/v8/finance/chart/" + ticker + "?range=1y&interval=1d")}`;
                const response = await fetch(proxy);
                const data = JSON.parse((await response.json()).contents);
                const result = data.chart.result[0];
                const prices = result.indicators.quote[0].close.filter(p => p != null);
                const lastPrice = prices[prices.length - 1];

                // 1. è²»æ³¢é‚£å¥‘è¨ˆç®— (å…¨å¥—)
                const high = Math.max(...result.indicators.quote[0].high.filter(p => p != null));
                const low = Math.min(...result.indicators.quote[0].low.filter(p => p != null));
                const diff = high - low;
                const fibs = {
                    "0.236": (high - 0.236 * diff).toFixed(2),
                    "0.382": (high - 0.382 * diff).toFixed(2),
                    "0.500": (high - 0.5 * diff).toFixed(2),
                    "0.618": (high - 0.618 * diff).toFixed(2),
                    "0.786": (high - 0.786 * diff).toFixed(2)
                };
                document.getElementById('fib618').innerText = fibs["0.618"];
                document.getElementById('allFibs').innerText = Object.entries(fibs).map(([k,v]) => `${k}:${v}`).join(' | ');

                // 2. è’™åœ°å¡ç¾…æ¨¡æ“¬ (180å¤©)
                const returns = [];
                for(let i=1; i<60; i++) returns.push(Math.log(prices[prices.length-i] / prices[prices.length-i-1]));
                const mu = returns.reduce((a,b)=>a+b)/returns.length;
                const sigma = Math.sqrt(returns.map(x => Math.pow(x-mu,2)).reduce((a,b)=>a+b)/returns.length);
                document.getElementById('volValue').innerText = (sigma * Math.sqrt(252) * 100).toFixed(2) + " %";

                const days = 180;
                const sims = 200; // ç€è¦½å™¨ç«¯è·‘ 200 æ¬¡è¼ƒæµæš¢
                let allPaths = [];
                for(let s=0; s<sims; s++) {
                    let path = [lastPrice];
                    for(let d=0; d<days; d++) {
                        let dailyRet = Math.exp((mu - 0.5 * sigma**2) + sigma * (Math.random()*2-1)*1.5);
                        path.push(path[path.length-1] * dailyRet);
                    }
                    allPaths.push(path);
                }

                // 3. ç¹ªåœ–
                const traces = allPaths.map((p, i) => ({
                    y: p, type: 'scatter', mode: 'lines', line: {width: 1, color: 'rgba(100,100,100,0.1)'}, showlegend: false
                }));

                const endPrices = allPaths.map(p => p[days]).sort((a,b)=>a-b);
                const p50 = endPrices[Math.floor(sims*0.5)].toFixed(2);
                document.getElementById('targetRange').innerText = `ç´„ ${p50}`;
                
                document.getElementById('conclusionText').innerHTML = `
                    <b>AI è¨ºæ–·ï¼š</b> æ ¹æ“š 180 å¤©æ¨¡æ“¬ï¼Œæ¨™çš„ç›®å‰è™•æ–¼é«˜é›†ä¸­åº¦å€åŸŸï¼Œ
                    ${p50 > lastPrice ? 'ğŸŸ¢ å‚¾å‘çœ‹æ¼²' : 'ğŸ”´ å‚¾å‘ç›¤æ•´/å›è½'}ã€‚
                    å»ºè­°ç”³è³¼åƒ¹è¨­åœ¨ <b>${fibs["0.618"]}</b> ä»¥ä¸‹æœ€ç‚ºç©©å¥ã€‚
                `;

                Plotly.newPlot('chart', traces, {
                    title: ticker + ' æœªä¾† 180 å¤©è’™åœ°å¡ç¾…èµ°å‹¢æ¨¡æ“¬',
                    yaxis: { title: 'åƒ¹æ ¼ (USD)' },
                    xaxis: { title: 'æœªä¾†å¤©æ•¸' }
                });

            } catch (e) { alert("æ•¸æ“šæŠ“å–å¤±æ•—"); }
        }
    </script>
</body>
</html>
