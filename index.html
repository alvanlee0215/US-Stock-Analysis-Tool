<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡å…¨èƒ½åˆ†æå„€ - èµ°å‹¢æ¨¡æ“¬èˆ‡ç”³è³¼åˆ¤æ–·</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #1a73e8; margin-top: 0; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        input { flex: 1; padding: 15px; border: 2px solid #edf2f7; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: #1a73e8; }
        button { padding: 15px 30px; background: #1a73e8; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; }
        button:hover { background: #1557b0; }

        .ai-card { background: #e8f0fe; border-left: 5px solid #1a73e8; padding: 20px; border-radius: 8px; margin-bottom: 25px; line-height: 1.6; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-box span { font-size: 12px; color: #70757a; display: block; margin-bottom: 5px; }
        .stat-box b { font-size: 20px; color: #202124; }

        .fib-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fafafa; border-radius: 8px; overflow: hidden; }
        .fib-table th, .fib-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .fib-table th { background: #f1f3f4; color: #5f6368; font-size: 13px; }
        
        #chart { width: 100%; height: 500px; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        .loading { display: none; color: #1a73e8; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š ç¾è‚¡å…¨èƒ½èµ°å‹¢åˆ†æå„€</h2>
    <p style="color: #666; font-size: 14px;">é©ç”¨æ–¼ï¼šå¼·å‹¢è‚¡å›æª” (å¦‚ MU) èˆ‡ ä¸‹è·Œè‚¡æŠ„åº• (å¦‚ TSLA)</p>
    
    <div class="input-group">
        <input type="text" id="symbolInput" placeholder="è¼¸å…¥ç¾è‚¡ä»£ç¢¼ (ä¾‹å¦‚: MU æˆ– NVDA)">
        <button onclick="startAnalysis()">åŸ·è¡Œ 180 å¤©æ¨¡æ“¬åˆ†æ</button>
    </div>

    <div id="loader" class="loading">âš™ï¸ æ­£åœ¨å‘å¤§æ•¸æ“šæ¥å£è«‹æ±‚ä¸¦é€²è¡Œ 1,000 æ¬¡è·¯å¾‘æ¨¡æ“¬...</div>

    <div id="aiConclusion" class="ai-card" style="display:none;"></div>

    <div class="grid">
        <div class="stat-box"><span>ç›®å‰å¸‚åƒ¹</span><b id="currPrice">--</b></div>
        <div class="stat-box"><span>å¹´ç·šä¹–é›¢ç‡ (Bias)</span><b id="biasValue">--%</b></div>
        <div class="stat-box"><span>180å¤©é ä¼°ä¸­ä½</span><b id="targetPrice">--</b></div>
    </div>

    <table class="fib-table" id="fibTable" style="display:none;">
        <thead>
            <tr>
                <th>è²»æ³¢é‚£å¥‘ä½éš</th>
                <th>åƒè€ƒåƒ¹æ ¼</th>
                <th>ç”³è³¼å ´æ™¯å»ºè­°</th>
            </tr>
        </thead>
        <tbody id="fibResults"></tbody>
    </table>

    <div id="chart"></div>
</div>

<script>
async function startAnalysis() {
    const symbol = document.getElementById('symbolInput').value.toUpperCase().trim();
    if (!symbol) return alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼");

    const loader = document.getElementById('loader');
    const aiBox = document.getElementById('aiConclusion');
    const fibTable = document.getElementById('fibTable');
    
    loader.style.display = 'block';
    aiBox.style.display = 'none';

    try {
        // ä½¿ç”¨ AllOrigins ä»£ç†ç¹é CORS é™åˆ¶
        const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=2y&interval=1d`;
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;
        
        const response = await fetch(proxyUrl);
        const rawData = await response.json();
        const data = JSON.parse(rawData.contents).chart.result[0];
        
        const indicators = data.indicators.quote[0];
        const closePrices = indicators.close.filter(p => p != null);
        const highPrices = indicators.high.filter(p => p != null);
        const lowPrices = indicators.low.filter(p => p != null);
        
        const currentPrice = closePrices[closePrices.length - 1];
        
        // 1. å¹´ç·šä¹–é›¢ç‡è¨ˆç®— (200MA Bias)
        const ma200 = closePrices.slice(-200).reduce((a, b) => a + b) / 200;
        const bias = ((currentPrice - ma200) / ma200 * 100).toFixed(2);

        // 2. è²»æ³¢é‚£å¥‘è¨ˆç®— (å…¨å¥—)
        const rangeHigh = Math.max(...highPrices);
        const rangeLow = Math.min(...lowPrices);
        const diff = rangeHigh - rangeLow;
        
        const fibLevels = [
            {lv: "0.382", p: (rangeHigh - 0.382 * diff).toFixed(2), note: "å¼·å‹¢è‚¡å›æª”æ”¯æ’ (é©åˆä½œå¤š)"},
            {lv: "0.500", p: (rangeHigh - 0.500 * diff).toFixed(2), note: "å¤šç©ºåˆ†æ°´å¶º"},
            {lv: "0.618", p: (rangeHigh - 0.618 * diff).toFixed(2), note: "é»ƒé‡‘åˆ†å‰²æ”¯æ’ (ç©©å¥ç”³è³¼åƒ¹)"},
            {lv: "0.786", p: (rangeHigh - 0.786 * diff).toFixed(2), note: "æ·±å±¤ä¿®æ­£åº•ç·š (æŠ„åº•åƒè€ƒ)"}
        ];

        // 3. è’™åœ°å¡ç¾…æ¨¡æ“¬ (180å¤©)
        let returns = [];
        for (let i = 1; i < 60; i++) {
            returns.push(Math.log(closePrices[closePrices.length - i] / closePrices[closePrices.length - i - 1]));
        }
        const mu = returns.reduce((a, b) => a + b) / returns.length;
        const sigma = Math.sqrt(returns.map(x => Math.pow(x - mu, 2)).reduce((a, b) => a + b) / returns.length);
        
        const days = 180;
        const sims = 120; // æ¨¡æ“¬æ¬¡æ•¸
        let paths = [];
        let finalPrices = [];

        for (let i = 0; i < sims; i++) {
            let p = [currentPrice];
            for (let d = 0; d < days; d++) {
                let change = (mu - 0.5 * sigma**2) + sigma * (Math.random() * 2 - 1) * 1.5;
                p.push(p[p.length - 1] * Math.exp(change));
            }
            paths.push(p);
            finalPrices.push(p[days]);
        }

        const medianTarget = (finalPrices.sort((a, b) => a - b)[Math.floor(sims / 2)]).toFixed(2);

        // æ›´æ–°ä»‹é¢æ•¸æ“š
        document.getElementById('currPrice').innerText = currentPrice.toFixed(2);
        document.getElementById('biasValue').innerText = bias + "%";
        document.getElementById('targetPrice').innerText = medianTarget;

        let fibHtml = "";
        fibLevels.forEach(f => {
            fibHtml += `<tr><td>${f.lv}</td><td><b>${f.p}</b></td><td>${f.note}</td></tr>`;
        });
        document.getElementById('fibResults').innerHTML = fibHtml;
        fibTable.style.display = 'table';

        // è¨ºæ–·çµè«–
        let diag = "";
        if (bias > 15) {
            diag = `ğŸ’¡ <b>è¨ºæ–·ï¼šæ¼²å¹…å·²é«˜ã€‚</b> ç›®å‰å¹´ç·šä¹–é›¢ç‡ ${bias}% åé«˜ï¼Œå»ºè­°ç­‰å¾…åƒ¹æ ¼æ‹‰å›åˆ° 0.382 ä½éš (ç´„ ${fibLevels[0].p}) å†è¡Œç”³è³¼è¼ƒå®‰å…¨ã€‚`;
        } else if (bias < -15) {
            diag = `ğŸ”¥ <b>è¨ºæ–·ï¼šåš´é‡è¶…è·Œã€‚</b> ç›®å‰å…·å‚™å¼·å¤§æŠ„åº•æ½›åŠ›ã€‚å»ºè­°åƒè€ƒ 0.618 (${fibLevels[2].p}) æˆ– 0.786 (${fibLevels[3].p}) ä½œç‚ºç”³è³¼åº•ç·šã€‚`;
        } else {
            diag = `âœ… <b>è¨ºæ–·ï¼šä½éšå¹³ç©©ã€‚</b> é©åˆæ ¹æ“šè²»æ³¢é‚£å¥‘é»ƒé‡‘æ”¯æ’ä½ ${fibLevels[2].p} é€²è¡Œç”³è³¼ä½ˆå±€ã€‚`;
        }
        aiBox.innerHTML = diag;
        aiBox.style.display = 'block';

        // ç¹ªåœ–
        const traces = paths.map(p => ({
            y: p, type: 'scatter', mode: 'lines', line: {width: 0.8, color: 'rgba(26, 115, 232, 0.1)'}, showlegend: false
        }));
        
        Plotly.newPlot('chart', traces, {
            title: `${symbol} æœªä¾† 180 å¤©èµ°å‹¢æ¨¡æ“¬ (è—è‰²å¯†é›†å€ç‚ºæ©Ÿç‡æœ€é«˜è·¯å¾‘)`,
            xaxis: { title: 'æœªä¾†å¤©æ•¸ (180D)' },
            yaxis: { title: 'é ä¼°åƒ¹æ ¼ (USD)' },
            margin: { t: 50, l: 50, r: 20, b: 50 }
        });

    } catch (error) {
        console.error(error);
        alert("æ•¸æ“šæŠ“å–å¤±æ•—ï¼Œè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢ºæˆ–ç¨å¾Œå†è©¦ã€‚");
    } finally {
        loader.style.display = 'none';
    }
}
</script>

</body>
</html>
