<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡çµ‚æ¥µå‹ç‡è¨ºæ–·å„€ - é›™ä»£ç†ç©©å®šç‰ˆ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; color: #1c1e21; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 15px; }
        .input-group { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; min-width: 150px; padding: 14px; border: 2px solid #e4e6eb; border-radius: 10px; font-size: 16px; outline: none; }
        input:focus { border-color: #0062ff; }
        button { padding: 14px 24px; background: #0062ff; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        .report-card { background: #f8f9fa; border-left: 8px solid #0062ff; padding: 20px; border-radius: 12px; margin-bottom: 25px; line-height: 1.8; font-size: 14px; display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .box { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; text-align: center; }
        .box span { font-size: 11px; color: #65676b; display: block; margin-bottom: 4px; }
        .box b { font-size: 18px; }

        #chart { width: 100%; height: 500px; margin-top: 20px; border-radius: 12px; }
        .loading { display: none; text-align: center; color: #0062ff; font-weight: bold; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>âš–ï¸ ç¾è‚¡çµ‚æ¥µå‹ç‡è¨ºæ–·å„€</h2>
        <p style="color:#666; font-size:13px;">Kç·šé æœŸ Ã— é›™ä»£ç†æ•¸æ“š Ã— ç´€å¾‹ç®¡ç†</p>
    </div>

    <div class="input-group">
        <input type="text" id="sym" placeholder="ä»£ç¢¼ (å¦‚: LEU, MU)">
        <input type="number" id="kP" placeholder="é æœŸç”³è³¼åƒ¹ (é¸å¡«)">
        <button onclick="startUltimateAnalysis()">å•Ÿå‹•æ·±åº¦è¨ºæ–·</button>
    </div>

    <div id="loader" class="loading">âš™ï¸ æ­£åœ¨åˆ‡æ›å®‰å…¨é€šé“æŠ“å–æ•¸æ“š (è«‹ç¨å€™)...</div>
    
    <div id="report" class="report-card"></div>

    <div id="statUI" style="display:none;">
        <div class="grid">
            <div class="box"><span>å®‰å…¨è©•åˆ†</span><b id="score">--</b></div>
            <div class="box"><span>å¹´ç·šä¹–é›¢ (Bias)</span><b id="bias">--%</b></div>
            <div class="box"><span>å‹•æ…‹åœåˆ©ç·š</span><b id="stop">--</b></div>
            <div class="box"><span>180å¤©é ä¼°ä¸­ä½</span><b id="target">--</b></div>
        </div>
        <div id="chart"></div>
    </div>
</div>

<script>
async function startUltimateAnalysis() {
    const symbol = document.getElementById('sym').value.toUpperCase().trim();
    const kP = parseFloat(document.getElementById('kP').value);
    if(!symbol) return;

    const loader = document.getElementById('loader');
    const reportBox = document.getElementById('report');
    const statUI = document.getElementById('statUI');
    
    loader.style.display = 'block';
    reportBox.style.display = 'none';
    statUI.style.display = 'none';

    // é›™ä»£ç†ä¼ºæœå™¨æ©Ÿåˆ¶
    const proxyList = [
        url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
        url => `https://corsproxy.io/?${encodeURIComponent(url)}`
    ];

    async function fetchWithRetry(url) {
        for (let i = 0; i < proxyList.length; i++) {
            try {
                const res = await fetch(proxyList[i](url));
                const data = await res.json();
                // è™•ç†ä¸åŒ Proxy çš„å›å‚³æ ¼å¼
                return i === 0 ? JSON.parse(data.contents) : data;
            } catch (err) {
                console.warn(`ä»£ç† ${i} å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹...`);
            }
        }
        throw new Error("æ‰€æœ‰ä»£ç†ä¼ºæœå™¨å‡å¤±æ•ˆ");
    }

    try {
        // 1. æŠ“å–æŠ€è¡“é¢æ•¸æ“š
        const cData = await fetchWithRetry(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=2y&interval=1d`);
        
        // å¼·åˆ¶åœé “ 1 ç§’ï¼Œé¿é–‹ Yahoo é »ç‡åµæ¸¬
        await new Promise(r => setTimeout(r, 1000));

        // 2. æŠ“å–åŸºæœ¬é¢æ•¸æ“š
        const fData = await fetchWithRetry(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData`);

        // æ•¸æ“šæå–èˆ‡ä¿è­·
        const chartRes = cData.chart.result[0];
        const fundRes = fData.quoteSummary.result[0];
        const close = chartRes.indicators.quote[0].close.filter(p => p != null);
        const curP = close[close.length - 1];
        
        // æŠ€è¡“æŒ‡æ¨™è¨ˆç®—
        const ma200 = close.slice(-200).reduce((a, b) => a + b) / 200;
        const bias = ((curP - ma200) / ma200 * 100).toFixed(2);
        const hi = Math.max(...chartRes.indicators.quote[0].high.filter(p => p != null));
        const lo = Math.min(...chartRes.indicators.quote[0].low.filter(p => p != null));
        const stopL = (Math.max(...close.slice(-20)) * 0.85).toFixed(2);

        // åŸºæœ¬é¢æ¬„ä½
        const pe = fundRes.summaryDetail?.forwardPE?.fmt || "N/A";
        const fcf = fundRes.financialData?.freeCashflow?.raw || 0;
        const debt = fundRes.financialData?.debtToEquity?.raw || 0;

        // å‹ç‡åˆ†æ•¸ (ç¶œåˆåˆ¤æ–·)
        let s = 85;
        if(parseFloat(bias) > 40) s -= 30;
        if(fcf < 0) s -= 15;
        if(debt > 120) s -= 10;

        // æ›´æ–°ä»‹é¢
        document.getElementById('score').innerText = s + " / 100";
        document.getElementById('bias').innerText = bias + "%";
        document.getElementById('stop').innerText = stopL;

        // è¨ºæ–·å ±å‘Š
        let rText = `<b>ğŸ¯ æ·±åº¦è¨ºæ–·å ±å‘Šï¼š</b><br>`;
        rText += `â€¢ <b>ä¼°å€¼åˆ†æï¼š</b> ${pe === 'N/A' ? 'ç›®å‰è™§æä¸­' : 'å‰ç» P/E ' + pe}ã€‚ç¾é‡‘æµï¼š${fcf < 0 ? 'âš  ç‡’éŒ¢ä¸­' : 'âœ… å¥å£¯'}ã€‚<br>`;
        rText += `â€¢ <b>é¢¨éšªè­¦ç¤ºï¼š</b> å¹´ç·šä¹–é›¢ç‡ ${bias}%ã€‚å‹•æ…‹åœåˆ©ä¿è­·ç·šï¼š<b>${stopL}</b>ã€‚<br>`;
        if(kP) {
            const fib618 = hi - 0.618 * (hi - lo);
            rText += `â€¢ <b>ç”³è³¼åƒ¹æ¸¬è©¦ï¼š</b> ${kP <= fib618 ? 'ğŸ”¥ ä½æ–¼é»ƒé‡‘æ”¯æ’å€' : 'â³ ç¨å¾®è¿½é«˜'} (åƒè€ƒæ”¯æ’ï¼š${fib618.toFixed(2)})<br>`;
        }
        rText += `<hr><b>ğŸ“œ ç´€å¾‹æé†’ï¼š</b> è¨˜ä½ LEU çš„æ•™è¨“ï¼Œè·Œç ´åœåˆ©ç·šè«‹ç«‹åˆ»åŸ·è¡Œæ¸›ç¢¼ã€‚`;
        reportBox.innerHTML = rText;
        reportBox.style.display = 'block';

        // ç†æ€§è·¯å¾‘æ¨¡æ“¬ (æ ¡æ­£æ¥µç«¯åå·®)
        let rets = []; for(let i=1; i<40; i++) rets.push(Math.log(close[close.length-i]/close[close.length-i-1]));
        const mu = (rets.reduce((a,b)=>a+b)/40) * 0.2; // é™ä½æ¼‚ç§»ç‡é¿å…èª‡å¼µé æ¸¬
        const sig = Math.sqrt(rets.map(x=>Math.pow(x-(mu/0.2),2)).reduce((a,b)=>a+b)/40);
        let paths = [];
        for(let i=0; i<50; i++){
            let p = [curP];
            for(let d=0; d<180; d++){ p.push(p[p.length-1] * Math.exp((mu - 0.5 * sig**2) + sig * (Math.random()*2-1)*1.1)); }
            paths.push(p);
        }
        document.getElementById('target').innerText = paths[0][180].toFixed(2);
        
        Plotly.newPlot('chart', paths.map(p=>({y:p, line:{width:0.5, color:'rgba(0,98,255,0.1)'}, showlegend:false})), {
            title: `${symbol} 180å¤©ç†æ€§æœŸæœ›è·¯å¾‘`, margin: {t:40, b:40, l:50, r:20}
        });

        statUI.style.display = 'block';

    } catch (e) {
        console.error(e);
        alert("è¨ºæ–·å¤±æ•—ï¼šä¼ºæœå™¨æ‹’çµ•é€£ç·šã€‚è«‹åˆ‡æ›ç¶²è·¯ï¼ˆæˆ–é–‹é—œé£›èˆªæ¨¡å¼ï¼‰ä¸¦ç­‰å¾… 1 åˆ†é˜å¾Œå†è©¦ã€‚");
    } finally {
        loader.style.display = 'none';
    }
}
</script>
</body>
</html>
