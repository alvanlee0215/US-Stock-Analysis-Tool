<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡å‹ç‡è¨ºæ–·å„€ - ç©©å®šå¼·åŒ–ç‰ˆ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; }
        .input-group { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; min-width: 150px; padding: 14px; border: 2px solid #e4e6eb; border-radius: 10px; font-size: 16px; outline: none; }
        button { padding: 14px 24px; background: #0062ff; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .report-card { background: #f8f9fa; border-left: 6px solid #0062ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; line-height: 1.8; font-size: 14px; display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .box { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; text-align: center; }
        .box span { font-size: 11px; color: #65676b; display: block; margin-bottom: 4px; }
        .box b { font-size: 18px; color: #1c1e21; }
        #chart { width: 100%; height: 500px; margin-top: 20px; border-radius: 12px; }
        .loading { display: none; text-align: center; color: #0062ff; font-weight: bold; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>âš–ï¸ ç¾è‚¡å‹ç‡è¨ºæ–·å„€ (ç©©å®šç‰ˆ)</h2>
        <p style="color:#666; font-size:13px;">æŠ€è¡“ K ç·š Ã— è²¡å‹™é«”è³ª Ã— åŸ·è¡Œç´€å¾‹</p>
    </div>

    <div class="input-group">
        <input type="text" id="sym" placeholder="ä»£ç¢¼ (å¦‚: LEU, MU)">
        <input type="number" id="kP" placeholder="é æœŸç”³è³¼åƒ¹">
        <button onclick="safeAnalyze()">å•Ÿå‹•æ·±åº¦è¨ºæ–·</button>
    </div>

    <div id="loader" class="loading">âš™ï¸ æ­£åœ¨å®‰å…¨è«‹æ±‚æ•¸æ“šä¸­ (è«‹ç¨å€™ 2 ç§’)...</div>
    <div id="report" class="report-card"></div>

    <div class="grid" id="statGrid" style="display:none;">
        <div class="box"><span>å®‰å…¨è©•åˆ†</span><b id="score">--</b></div>
        <div class="box"><span>å¹´ç·šä¹–é›¢</span><b id="bias">--%</b></div>
        <div class="box"><span>å‹•æ…‹åœåˆ©ç·š</span><b id="stop">--</b></div>
    </div>

    <div id="chart"></div>
</div>

<script>
async function safeAnalyze() {
    const symbol = document.getElementById('sym').value.toUpperCase().trim();
    const kP = parseFloat(document.getElementById('kP').value);
    if(!symbol) return;

    const loader = document.getElementById('loader');
    const reportBox = document.getElementById('report');
    const statGrid = document.getElementById('statGrid');
    
    loader.style.display = 'block';
    reportBox.style.display = 'none';
    statGrid.style.display = 'none';

    try {
        const proxy = url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        
        // 1. æŠ“å–æŠ€è¡“é¢ (Chart)
        const cResRaw = await fetch(proxy(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=2y&interval=1d`));
        const cRes = await cResRaw.json();
        if(!cRes.contents) throw new Error("æŠ€è¡“æ•¸æ“šæŠ“å–å¤±æ•—");
        const cData = JSON.parse(cRes.contents).chart.result[0];
        
        // è«‹æ±‚é–“éš”ï¼Œé¿é–‹æª¢æ¸¬
        await new Promise(r => setTimeout(r, 600));

        // 2. æŠ“å–åŸºæœ¬é¢ (Fundamentals)
        const fResRaw = await fetch(proxy(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData`));
        const fRes = await fResRaw.json();
        if(!fRes.contents) throw new Error("åŸºæœ¬é¢æ•¸æ“šæŠ“å–å¤±æ•—");
        const fData = JSON.parse(fRes.contents).quoteSummary.result[0];

        // æ•¸æ“šæå–èˆ‡ä¿è­·é‚è¼¯
        const close = cData.indicators.quote[0].close.filter(p => p != null);
        const curP = close[close.length - 1];
        const ma200 = close.slice(-200).reduce((a, b) => a + b) / 200;
        const bias = ((curP - ma200) / ma200 * 100).toFixed(2);
        const hi = Math.max(...cData.indicators.quote[0].high.filter(p => p != null));
        const lo = Math.min(...cData.indicators.quote[0].low.filter(p => p != null));
        const stopL = (Math.max(...close.slice(-20)) * 0.85).toFixed(2);

        // åŸºæœ¬é¢æ¬„ä½é˜²å‘†
        const pe = fData.summaryDetail?.forwardPE?.fmt || "N/A";
        const fcf = fData.financialData?.freeCashflow?.raw || 0;
        const debt = fData.financialData?.debtToEquity?.raw || 0;

        // å‹ç‡è©•åˆ†
        let s = 80;
        if(parseFloat(bias) > 40) s -= 30;
        if(fcf < 0) s -= 15;
        if(debt > 120) s -= 10;

        // UI æ›´æ–°
        document.getElementById('score').innerText = s + " / 100";
        document.getElementById('bias').innerText = bias + "%";
        document.getElementById('stop').innerText = stopL;
        statGrid.style.display = 'grid';

        // å ±å‘Šç”Ÿæˆ
        let rText = `<b>ğŸ¯ æ·±åº¦è¨ºæ–·å ±å‘Šï¼š</b><br>`;
        rText += `â€¢ <b>ä¼°å€¼åˆ†æï¼š</b> ${pe === 'N/A' ? 'è™§æä¸­' : 'å‰ç» P/E ' + pe}ï¼Œç¾é‡‘æµï¼š${fcf < 0 ? 'âš  è² å‘' : 'âœ… æ­£å‘'}<br>`;
        rText += `â€¢ <b>å‹•æ…‹ä¿è­·ï¼š</b> ç•¶å‰åœåˆ©ç·š <b>${stopL}</b>ï¼Œè·Œç ´è«‹åŸ·è¡Œç´€å¾‹ã€‚<br>`;
        if(kP) {
            const fib618 = hi - 0.618 * (hi - lo);
            rText += `â€¢ <b>é æœŸåƒ¹åˆ†æï¼š</b> ${kP <= fib618 ? 'ğŸ”¥ ä½æ–¼é»ƒé‡‘æ”¯æ’å€' : 'â³ ç•¥é¡¯è¿½é«˜'} (æ”¯æ’ä½ç´„ ${fib618.toFixed(2)})<br>`;
        }
        rText += `<hr><b>ğŸ“œ ç´€å¾‹ï¼š</b> ä¸è¦å› ç‚ºç²åˆ©è€Œè‡ªå¤§ï¼Œä¸è¦å› ç‚ºè™§æè€Œææ‡¼ã€‚è¨­å®šåœæï¼Œåš´æ ¼åŸ·è¡Œã€‚`;
        reportBox.innerHTML = rText;
        reportBox.style.display = 'block';

        // ç¹ªè£½ç†æ€§æ¨¡æ“¬åœ–
        let rets = []; for(let i=1; i<40; i++) rets.push(Math.log(close[close.length-i]/close[close.length-i-1]));
        const mu = (rets.reduce((a,b)=>a+b)/40) * 0.35;
        const sig = Math.sqrt(rets.map(x=>Math.pow(x-(mu/0.35),2)).reduce((a,b)=>a+b)/40);
        let paths = [];
        for(let i=0; i<50; i++){
            let p = [curP];
            for(let d=0; d<180; d++){ p.push(p[p.length-1] * Math.exp((mu - 0.5 * sig**2) + sig * (Math.random()*2-1)*1.1)); }
            paths.push(p);
        }
        Plotly.newPlot('chart', paths.map(p=>({y:p, line:{width:0.5, color:'rgba(0,98,255,0.1)'}, showlegend:false})), {title: `${symbol} 180å¤©ç†æ€§æœŸæœ›è·¯å¾‘`});

    } catch (e) {
        console.error(e);
        alert("è¨ºæ–·å¤±æ•—ï¼šä¼ºæœå™¨æ‹’çµ•é€£ç·šã€‚è«‹ç¨å€™ 10 ç§’å¾Œå†è©¦ï¼Œæˆ–å˜—è©¦æ›´æ›ä»£ç¢¼ã€‚");
    } finally {
        loader.style.display = 'none';
    }
}
</script>
</body>
</html>
