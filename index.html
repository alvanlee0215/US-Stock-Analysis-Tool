<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡å‹ç‡è¨ºæ–·å„€ - å®Œå…¨é«”æ•´åˆç‰ˆ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; color: #1c1e21; }
        .container { max-width: 650px; margin: auto; background: white; padding: 20px; border-radius: 24px; box-shadow: 0 12px 45px rgba(0,0,0,0.15); }
        .header { text-align: center; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; min-width: 140px; padding: 15px; border: 2px solid #e4e6eb; border-radius: 14px; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: #0062ff; box-shadow: 0 0 0 3px rgba(0,98,255,0.1); }
        button { padding: 15px; background: #0062ff; color: white; border: none; border-radius: 14px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #bcc0c4; cursor: not-allowed; }
        
        /* è©•åˆ†å€ */
        .score-box { background: linear-gradient(135deg, #0062ff, #00c6ff); color: white; padding: 22px; border-radius: 18px; text-align: center; margin-bottom: 20px; display: none; }
        .score-val { font-size: 48px; font-weight: 900; display: block; line-height: 1; margin: 10px 0; }
        
        /* æ•¸æ“šæ ¼ */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .box { background: #f7f8fa; border: 1px solid #e4e6eb; padding: 15px; border-radius: 14px; text-align: center; }
        .box span { font-size: 12px; color: #65676b; display: block; margin-bottom: 4px; }
        .box b { font-size: 18px; color: #050505; }

        .report-card { background: #fff; border-left: 6px solid #0062ff; padding: 20px; border-radius: 12px; border: 1px solid #e4e6eb; border-left-width: 6px; line-height: 1.8; font-size: 15px; display: none; margin-bottom: 20px; }
        #chart { width: 100%; height: 450px; border-radius: 18px; margin-top: 10px; }
        .loading { display: none; text-align: center; color: #0062ff; font-weight: bold; padding: 20px; font-size: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0;">âš–ï¸ ç¾è‚¡å‹ç‡è¨ºæ–·å„€</h2>
        <p style="color:#65676b; font-size:14px; margin:8px 0 0;">å¤§æ•¸æ“šé‡åŒ–åˆ†æ Â· ç²åˆ©å®ˆè­·ç³»çµ±</p>
    </div>

    <div class="input-group">
        <input type="text" id="sym" placeholder="ä»£ç¢¼ (ä¾‹: LEU)">
        <input type="number" id="kP" placeholder="é æœŸè²·å›åƒ¹">
        <button id="btn" onclick="runDiagnostic()">å•Ÿå‹•æ·±åº¦è¨ºæ–·</button>
    </div>

    <div id="loader" class="loading">âš™ï¸ æ­£åœ¨å®‰å…¨ç©¿é€æ•¸æ“šé€šé“ï¼Œè«‹ç¨å€™...</div>

    <div id="scoreBox" class="score-box">
        <span style="font-weight:600; opacity:0.9;">å‹ç‡å®‰å…¨è©•åˆ†</span>
        <b id="scoreVal" class="score-val">--</b>
        <span id="riskLevel" style="font-size:14px; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:20px;">åˆ†æä¸­...</span>
    </div>

    <div id="statGrid" class="grid" style="display:none;">
        <div class="box"><span>ç›®å‰ç¾åƒ¹</span><b id="curP">--</b></div>
        <div class="box"><span>å¹´ç·šä¹–é›¢ (Bias)</span><b id="bias">--</b></div>
        <div class="box"><span>å‹•æ…‹åœåˆ©ç·š</span><b id="stop">--</b></div>
        <div class="box"><span>å‰ç» P/E</span><b id="pe">--</b></div>
    </div>

    <div id="report" class="report-card"></div>
    <div id="chart"></div>
</div>

<script>
async function runDiagnostic() {
    const symbol = document.getElementById('sym').value.toUpperCase().trim();
    const kP = parseFloat(document.getElementById('kP').value);
    if(!symbol) return;

    const btn = document.getElementById('btn');
    const loader = document.getElementById('loader');
    const scoreBox = document.getElementById('scoreBox');
    const statGrid = document.getElementById('statGrid');
    const reportBox = document.getElementById('report');
    
    btn.disabled = true;
    loader.style.display = 'block';
    scoreBox.style.display = 'none';
    statGrid.style.display = 'none';
    reportBox.style.display = 'none';

    const proxy = u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&_t=${Date.now()}`;

    try {
        // 1. æŠ“å– K ç·šæ•¸æ“š
        const cRes = await fetch(proxy(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=2y&interval=1d`), { cache: 'no-store' });
        const cData = JSON.parse((await cRes.json()).contents).chart.result[0];
        
        await new Promise(r => setTimeout(r, 1200));

        // 2. æŠ“å–åŸºæœ¬é¢æ•¸æ“š
        const fRes = await fetch(proxy(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData`), { cache: 'no-store' });
        const fData = JSON.parse((await fRes.json()).contents).quoteSummary.result[0];

        const close = cData.indicators.quote[0].close.filter(p => p != null);
        const curPrice = close[close.length - 1];
        const ma200 = close.slice(-200).reduce((a, b) => a + b) / 200;
        const bias = ((curPrice - ma200) / ma200 * 100).toFixed(2);
        const hi = Math.max(...cData.indicators.quote[0].high.filter(p => p != null));
        const lo = Math.min(...cData.indicators.quote[0].low.filter(p => p != null));
        const fib618 = hi - 0.618 * (hi - lo);
        const stopL = (Math.max(...close.slice(-20)) * 0.85).toFixed(2);

        // è²¡å‹™åƒæ•¸
        const pe = fData.summaryDetail?.forwardPE?.fmt || "N/A";
        const fcf = fData.financialData?.freeCashflow?.raw || 0;
        const debt = fData.financialData?.debtToEquity?.raw || 0;

        // --- æ ¸å¿ƒè©•åˆ†é‚è¼¯ (æ³¢å‹•åº¦èˆ‡é¢¨éšªåŠ æ¬Š) ---
        let s = 80;
        if(parseFloat(bias) > 30) s -= 25; // éç†±
        if(parseFloat(bias) < -15) s -= 15; // ç©ºé ­è¶¨å‹¢
        if(fcf < 0) s -= 15; // ç‡’éŒ¢é¢¨éšª
        if(debt > 150) s -= 10; // å‚µå‹™å£“åŠ›
        if(curPrice < parseFloat(stopL)) s -= 10; // ç ´ä½æ‰£åˆ†

        // æ›´æ–° UI
        document.getElementById('scoreVal').innerText = s + " / 100";
        document.getElementById('riskLevel').innerText = s >= 70 ? "âœ… å‹ç‡è¼ƒé«˜" : (s >= 50 ? "â³ è§€æœ›ç‚ºå®œ" : "âš ï¸ é¢¨éšªæ¥µå¤§");
        document.getElementById('curP').innerText = "$" + curPrice.toFixed(2);
        document.getElementById('bias').innerText = bias + "%";
        document.getElementById('pe').innerText = pe;
        document.getElementById('stop').innerText = "$" + stopL;

        let rText = `<b>ğŸ“Š å¯¦æˆ°è¨ºæ–·å ±å‘Šï¼š</b><br>`;
        rText += `â€¢ <b>è²¡å‹™ç¾æ³ï¼š</b>è‡ªç”±ç¾é‡‘æµ ${fcf < 0 ? '<span style="color:red">è² å‘</span>' : 'å¥å…¨'}ï¼Œè² å‚µæ¯” ${debt.toFixed(1)}%ã€‚<br>`;
        rText += `â€¢ <b>é—œéµæ”¯æ’ï¼š</b> è²»æ³¢é‚£å¥‘ 0.618 ä½éšåœ¨ <b>$${fib618.toFixed(2)}</b>ã€‚<br>`;
        
        if(kP) {
            const gap = ((kP - fib618) / fib618 * 100).toFixed(1);
            rText += `â€¢ <b>è²·å›æ¸¬è©¦ ($${kP})ï¼š</b> ${kP <= fib618 ? '<b style="color:green">ğŸ”¥ ç¬¦åˆå„ªè³ªæ”¯æ’</b>' : '<b style="color:orange">â³ ä»å±¬è¿½é«˜</b>'} (è·æ”¯æ’ ${gap}%)ã€‚<br>`;
        }
        
        rText += `<hr><b>ğŸ“œ ç´€å¾‹æŒ‡å¼•ï¼š</b> ç›®å‰åƒ¹ä½${curPrice < parseFloat(stopL) ? ' <span style="color:red">å·²è·Œç ´</span>' : ' å°šå®ˆåœ¨'}åœåˆ©ç·šä¹‹ä¸Šã€‚è‹¥è·Œç ´ $${stopL} è«‹å‹™å¿…åŸ·è¡Œæ¸›ç¢¼ã€‚`;
        
        scoreBox.style.display = 'block';
        statGrid.style.display = 'grid';
        reportBox.innerHTML = rText;
        reportBox.style.display = 'block';

        // æ³¢å‹•åº¦è·¯å¾‘æ¨¡æ“¬ (è’™åœ°å¡ç¾…)
        let paths = [];
        for(let i=0; i<35; i++){
            let p = [curPrice];
            for(let d=0; d<180; d++){ 
                // åŸºæ–¼éš¨æ©Ÿæ³¢å‹•æ¨¡æ“¬ 180 å¤©èµ°å‹¢
                p.push(p[p.length-1] * (1 + (Math.random()-0.492)*0.04)); 
            }
            paths.push(p);
        }
        Plotly.newPlot('chart', paths.map(p=>({y:p, line:{width:0.7, color:'rgba(0,98,255,0.12)'}, showlegend:false})), 
        { title: `${symbol} 180å¤©æ©Ÿç‡æœŸæœ›è·¯å¾‘`, margin: {t:40, b:40, l:40, r:10} });

    } catch (e) {
        alert("Yahoo åµæ¸¬åˆ°é »ç¹å­˜å–ã€‚è«‹é–‹å•Ÿæ‰‹æ©Ÿã€Œé£›èˆªæ¨¡å¼ã€30ç§’æ› IPï¼Œä¸¦ä½¿ç”¨ã€Œç„¡ç—•æ¨¡å¼ã€å†è©¦ä¸€æ¬¡ã€‚");
    } finally {
        loader.style.display = 'none';
        setTimeout(() => { btn.disabled = false; }, 4000);
    }
}
</script>
</body>
</html>
